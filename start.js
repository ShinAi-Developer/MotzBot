
// Ini template bot yang udah jadi dari library asli @whiskeysockets/baileys

const{default:makeWASocket,useMultiFileAuthState:e,DisconnectReason:a,fetchLatestBaileysVersion:o}=require("@whiskeysockets/baileys"),qrcode=require("qrcode-terminal"),fs=require("fs-extra"),handlerMessage=require("./core/handler/handlerMessage"),{botBehavior:t}=require("./settings/botConfig"),{formatTime:r}=require("./core/utils"),motz=require("./core/logger/motz"),P=require("pino"),log=require("./core/logger/logger");require("dotenv").config();let lastQrCode=null,pairingRequested=!1,qrRequested=!1,reconnect=!1;const authFolder="./auth",credsAuth=`${authFolder}/creds.json`,wasFirstLogin=!fs.existsSync(credsAuth);async function startBot(){try{let{state:r,saveCreds:n}=await e("./auth"),{version:s}=await o(),l=makeWASocket({version:s,auth:r,printQRInTerminal:!1,logger:P({level:"silent"})});l.ev.on("connection.update",async e=>{let{connection:o,lastDisconnect:r,qr:n}=e,s=process.argv.slice(2),i=s.includes("--qrcode"),d=s.find(e=>e.startsWith("--prcode=")),g=!!d,u=g?d.split("=")[1]:null,c=t.botLabel;bN=t.botName;g&&!/^628\d{7,15}$/.test(u)&&(log.error("Nomor WA tidak valid. Gunakan format internasional, contoh: --prcode=628xxx"),process.exit(1));let k=fs.existsSync(credsAuth);if(k||i||g||(log.error("Kamu belum login"),log.info("Untuk login jalankan \nnode start --qrcode (untuk login menggunakan qr code) atau \nnode start --prcode=628xxx (untuk login dengan pairing kode. dan pastikan tidak memakai format +628xxx, +62 8xx-xxx atau 08xxx)"),process.exit(1)),n&&g&&u)try{pairingRequested=!0;let m=await l.requestPairingCode(u),h=m.slice(0,4)+"-"+m.slice(4);log.pcd("Silahkan masukan kode ini: "+h)}catch(p){log.error("Gagal masuk pakai pair code. Error: "+p),await fs.remove(authFolder),log.info("Coba masuk dengan qr code"),process.exit(1)}if(n&&i)try{n!==lastQrCode?(lastQrCode=n,qrRequested=!0,log.sqr("Silakan scan kode qr code berikut:"),qrcode.generate(n,{small:!0})):log.sqr("Menunggu scan qr code yang sama...")}catch(f){log.error("Gagal masuk pakai qr code. Error: "+f.message),await fs.remove(authFolder),log.info("Coba masuk dengan pair code"),process.exit(1)}if(c||c===""||(log.error("botLabel tidak ada. Pastikan bot label tidak di hapus"),process.exit(1)))if(bN||bN===""||(log.error("botName tidak ada. Pastikan bot name tidak di hapus"),process.exit(1)),"close"===o){let q=r?.error?.output?.statusCode,x=q===a.loggedOut,_=!1;401===q&&(k?(_=!0,log.error("Auth tidak valid atau rusak. Mencoba menghapus auth..."),await fs.remove(authFolder),log.info("Mencoba login ulang dalam 5 detik...")):log.info("Tidak ditemukan auth, menunggu login...")),x&&(log.info("Logout permanen. Menghapus auth..."),await fs.remove(authFolder),log.info("Mencoba login ulang dalam 5 detik..."),lastQrCode=null),515!==q&&(log.info(`Koneksi terputus. Alasan: ${q}`),log.info("Mencoba reconnect dalam 5 detik..."),reconnect=!0),setTimeout(()=>startBot(),5e3)}else"open"===o&&(k&&(g||i)&&!(qrRequested||pairingRequested)&&!wasFirstLogin&&(log.error("Kamu sudah login"),log.info("Jalankan ulang bot tanpa --qrcode/--prcode"),process.exit(1)),r||reconnect?log.success("Bot berhasil reconnect ke WhatsApp!"):(log.clear(),motz(),log.success("Bot berhasil terhubung ke WhatsApp!"),reconnect=!1),lastQrCode=null,pairingRequested=!1,qrRequested=!1)}),l.ev.on("creds.update",n),l.ev.on("messages.upsert",async({messages:e})=>{let a=e[0];if(a.message)try{await handlerMessage(l,a)}catch(o){log.error(`Gagal memproses pesan: ${o.stack}`)}})}catch(i){log.error(`Error saat inisialisasi bot: ${i}`),log.info("Mencoba restart dalam 10 detik..."),lastQrCode=null,pairingRequested=!1,qrRequested=!1,setTimeout(()=>{startBot()},1e4)}}startBot();